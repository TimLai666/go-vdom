# v1.2.1 API 一致性改進

## 概述

v1.2.1 版本對 `Do()` 和 `AsyncDo()` 進行了重要的 API 改進，使其簽名與 `Fn()` 和 `AsyncFn()` 保持完全一致。

## 變更內容

### API 簽名統一

**之前（不一致）：**
```go
func Fn(params []string, actions ...JSAction) JSAction       // 需要 []string
func AsyncFn(params []string, actions ...JSAction) JSAction  // 需要 []string
func Do(actions ...JSAction) JSAction                        // 不需要參數列表
func AsyncDo(actions ...JSAction) JSAction                   // 不需要參數列表
```

**現在（一致）：**
```go
func Fn(params []string, actions ...JSAction) JSAction       // 需要 []string
func AsyncFn(params []string, actions ...JSAction) JSAction  // 需要 []string
func Do(params []string, actions ...JSAction) JSAction       // 需要 []string ✅
func AsyncDo(params []string, actions ...JSAction) JSAction  // 需要 []string ✅
```

## 遷移步驟

### 自動遷移

**Linux/Mac:**
```bash
find . -name "*.go" -exec sed -i 's/js\.Do(/js.Do(nil,/g' {} \;
find . -name "*.go" -exec sed -i 's/js\.AsyncDo(/js.AsyncDo(nil,/g' {} \;
```

**Windows (PowerShell):**
```powershell
Get-ChildItem -Recurse -Filter *.go | ForEach-Object {
    (Get-Content $_.FullName) -replace 'js\.Do\(', 'js.Do(nil,' | Set-Content $_.FullName
    (Get-Content $_.FullName) -replace 'js\.AsyncDo\(', 'js.AsyncDo(nil,' | Set-Content $_.FullName
}
```

### 手動遷移

**查找並替換：**

1. `js.Do(` → `js.Do(nil,`
2. `js.AsyncDo(` → `js.AsyncDo(nil,`

**範例：**

```go
// 舊代碼
Button(Props{
    "onClick": js.Do(
        js.Alert("'Hello'"),
    ),
}, "Click")

// 新代碼
Button(Props{
    "onClick": js.Do(nil,
        js.Alert("'Hello'"),
    ),
}, "Click")
```

## 使用方式

### 1. 無參數（最常見 - 95% 的情況）

```go
// 同步事件
"onClick": js.Do(nil,
    js.Alert("'Hello!'"),
)

// 異步事件
"onClick": js.AsyncDo(nil,
    js.Const("data", "await fetch('/api')"),
    js.Alert("'Done!'"),
)
```

### 2. 帶參數（進階用法 - 5% 的情況）

```go
// 同步 IIFE 帶參數
js.Do([]string{"x", "y"},
    js.Const("sum", "x + y"),
    js.Log("sum"),
)

// 異步 IIFE 帶參數
js.AsyncDo([]string{"event"},
    js.Const("target", "event.target"),
    js.Log("target"),
)
```

**注意**：在 HTML 事件處理器中，`event` 對象自動可用，無需聲明為參數。

## 為什麼要改？

### 1. API 一致性

所有四個函數現在使用完全相同的簽名模式：

```go
func Fn(params []string, actions ...JSAction) JSAction
func AsyncFn(params []string, actions ...JSAction) JSAction
func Do(params []string, actions ...JSAction) JSAction
func AsyncDo(params []string, actions ...JSAction) JSAction
```

這樣更容易記憶和理解。

### 2. 類型明確

```go
// 舊方式（模糊）
js.Do(action1, action2)  // 看不出是否有參數

// 新方式（清晰）
js.Do(nil, action1, action2)  // 明確表示無參數
```

### 3. IDE 支持更好

明確的類型使 IDE 能提供更好的：
- 自動補全
- 類型檢查
- 參數提示

### 4. 可擴展性

統一的簽名使未來擴展更容易，不需要多個重載版本。

## 實際影響

### Breaking Change

這是一個 **breaking change**，所有使用 `Do()` 和 `AsyncDo()` 的代碼都需要更新。

### 受影響的代碼

所有事件處理器：
- `onClick`
- `onChange`
- `onInput`
- `onSubmit`
- `onMouseOver`
- `onMouseOut`
- `onFocus`
- `onBlur`
- 等等...

### 不受影響的代碼

- `Fn()` 和 `AsyncFn()` 使用者（簽名未變）
- 非事件處理相關代碼
- 其他所有 jsdsl 函數

## 遷移檢查清單

- [ ] 備份代碼
- [ ] 運行查找替換命令
- [ ] 編譯項目：`go build ./...`
- [ ] 檢查編譯錯誤
- [ ] 手動修復遺漏的地方
- [ ] 運行測試
- [ ] 在瀏覽器中測試所有交互功能
- [ ] 檢查瀏覽器控制台是否有錯誤

## 常見錯誤

### 錯誤 1：忘記添加 nil

```go
// ❌ 錯誤
"onClick": js.Do(
    js.Alert("'Hello'"),
)

// ✅ 正確
"onClick": js.Do(nil,
    js.Alert("'Hello'"),
)
```

**編譯錯誤**：
```
not enough arguments in call to js.Do
```

### 錯誤 2：參數類型錯誤

```go
// ❌ 錯誤
"onClick": js.Do("x",  // 傳入 string 而非 []string
    js.Alert("'Hello'"),
)

// ✅ 正確
"onClick": js.Do([]string{"x"},
    js.Alert("'Hello'"),
)
```

**編譯錯誤**：
```
cannot use "x" (type string) as type []string
```

## 完整範例對比

### 按鈕點擊

```go
// v1.2.0
Button(Props{
    "onClick": js.Do(
        js.Alert("'Clicked!'"),
    ),
}, "Click")

// v1.2.1
Button(Props{
    "onClick": js.Do(nil,
        js.Alert("'Clicked!'"),
    ),
}, "Click")
```

### 表單提交

```go
// v1.2.0
Form(Props{
    "onSubmit": js.Do(
        js.CallMethod("event", "preventDefault"),
        js.Alert("'Submitted!'"),
    ),
})

// v1.2.1
Form(Props{
    "onSubmit": js.Do(nil,
        js.CallMethod("event", "preventDefault"),
        js.Alert("'Submitted!'"),
    ),
})
```

### 異步 API 調用

```go
// v1.2.0
Button(Props{
    "onClick": js.AsyncDo(
        js.Const("data", "await fetch('/api')"),
        js.Alert("'Done!'"),
    ),
}, "Load")

// v1.2.1
Button(Props{
    "onClick": js.AsyncDo(nil,
        js.Const("data", "await fetch('/api')"),
        js.Alert("'Done!'"),
    ),
}, "Load")
```

## 統計數據

從項目示例的遷移統計：

| 文件 | Do/AsyncDo 調用數 | 遷移時間 |
|------|------------------|---------|
| 03_javascript_dsl.go | 15 | < 1 分鐘 |
| 05_foreach_usage.go | 4 | < 1 分鐘 |
| 07_trycatch_usage.go | 8 | < 1 分鐘 |
| 08_minified_js.go | 4 | < 1 分鐘 |
| 09_event_handlers.go | 20 | < 1 分鐘 |
| **總計** | **51** | **< 5 分鐘** |

使用自動化腳本，整個項目的遷移在 1 分鐘內完成。

## 優點總結

✅ **一致性**：所有函數簽名相同  
✅ **清晰性**：明確表明是否有參數  
✅ **可維護性**：更容易理解和修改  
✅ **IDE 支持**：更好的自動補全和類型檢查  
✅ **可擴展性**：統一的模式便於未來擴展  
✅ **易於學習**：只需記住一個模式  

## 相關文檔

- [DO_ASYNCDO_PARAMS.md](DO_ASYNCDO_PARAMS.md) - 詳細參數說明
- [EVENT_HANDLER_CHANGES.md](EVENT_HANDLER_CHANGES.md) - 事件處理器變更
- [V1.2.1_SUMMARY.md](V1.2.1_SUMMARY.md) - 完整版本摘要
- [examples/10_do_with_params.go](../examples/10_do_with_params.go) - 參數使用示例

## 版本歷史

- **v1.2.1** - 統一 API 簽名，Do/AsyncDo 需要 params 參數
- **v1.2.0** - 引入 Do/AsyncDo，但簽名與 Fn/AsyncFn 不一致
- **v1.1.x** - 僅有 Fn/AsyncFn

## 結論

雖然這是一個 breaking change，但它帶來了：

1. **更好的 API 設計** - 一致且清晰
2. **快速遷移** - 自動化工具可在 1 分鐘內完成
3. **長期收益** - 更易維護和擴展的代碼庫

我們認為這個短期的遷移成本換來的長期收益是值得的。

---

**升級建議**：立即升級並遷移，使用提供的自動化腳本可快速完成。