# Go VDOM v1.2.1 Release Summary

## Overview

Version 1.2.1 simplifies event handler rendering by removing automatic function detection and wrapping. This change provides developers with explicit control over event handler execution and eliminates a class of confusing errors.

## Key Changes

### 1. Removed Automatic Function Wrapping

**What was removed:**
- Complex detection logic that tried to identify function definitions vs statements
- Automatic wrapping of event handlers in `function(evt,el){...}`
- Handler registry system (`window.__gvd.handlers`)
- `data-gvd-handler` attribute generation

**Why it was removed:**
- `js.AsyncDo()` was being misdetected as a function definition
- Caused errors like "...is not a function"
- Added unnecessary complexity
- Made debugging difficult
- Gave developers less control

### 2. Simplified Event Handler Rendering

Event handlers now render **exactly as provided** with no transformations:

**Before (v1.2.0):**
```go
Button(Props{
    "onClick": js.AsyncFn(nil,
        js.Alert("'Hello'"),
    ),
}, "Click")
// Generated: data-gvd-handler="h-123-456|click" + registry script
// Result: Complex, error-prone
```

**After (v1.2.1):**
```go
Button(Props{
    "onClick": js.AsyncDo(nil,
        js.Alert("'Hello'"),
    ),
}, "Click")
// Generated: onclick="(async()=>{alert('Hello')})()"
// Result: Simple, direct, predictable
```

## Migration Guide

### Breaking Changes

If you used `js.Fn()` or `js.AsyncFn()` for event handlers, you must update them:

#### ❌ Before (Broken in v1.2.1)
```go
// These NO LONGER WORK as event handlers
Button(Props{
    "onClick": js.Fn(nil,
        js.Alert("'Hello'"),
    ),
}, "Click")

Button(Props{
    "onClick": js.AsyncFn(nil,
        js.Const("data", "await fetch('/api')"),
    ),
}, "Load")
```

#### ✅ After (Correct Usage)
```go
// Use js.Do() for synchronous handlers
Button(Props{
    "onClick": js.Do(nil,
        js.Alert("'Hello'"),
    ),
}, "Click")

// Use js.AsyncDo() for async handlers
Button(Props{
    "onClick": js.AsyncDo(nil,
        js.Const("data", "await fetch('/api')"),
        js.Alert("'Done!'"),
    ),
}, "Load")
```

### Quick Migration Pattern

1. Find: `"onClick": js.Fn(nil,`
2. Replace: `"onClick": js.Do(nil,`

3. Find: `"onClick": js.AsyncFn(nil,`
4. Replace: `"onClick": js.AsyncDo(nil,`

This pattern works for all event types: `onClick`, `onChange`, `onInput`, etc.

## Common Patterns

### 1. Simple Alert
```go
"onClick": js.Do(nil,
    js.Alert("'Button clicked!'"),
)
```

### 2. DOM Manipulation
```go
"onClick": js.Do(nil,
    js.Const("el", "document.getElementById('myDiv')"),
    JSAction{Code: "el.style.display = 'none'"},
)
```

### 3. Counter Update
```go
"onClick": js.Do(nil,
    js.Const("el", "document.getElementById('counter')"),
    js.Const("count", "parseInt(el.textContent) + 1"),
    JSAction{Code: "el.textContent = count"},
)
```

### 4. API Call with Error Handling
```go
"onClick": js.AsyncDo(nil,
    js.Const("container", "document.getElementById('result')"),
    JSAction{Code: "container.innerHTML = 'Loading...'"},
    js.Try(
        js.Const("response", "await fetch('/api/data')"),
        js.Const("data", "await response.json()"),
        JSAction{Code: "container.innerHTML = 'Success: ' + data.message"},
    ).Catch(
        JSAction{Code: "container.innerHTML = 'Error: ' + error.message"},
    ).End(),
)
```

### 5. Form Input Handler
```go
"onInput": js.Do(nil,
    js.Const("value", "event.target.value"),
    JSAction{Code: "document.getElementById('output').textContent = value"},
)
```

### 6. Multiple Events
```go
Div(Props{
    "onClick": js.Do(nil,
        js.Log("'Clicked'"),
    ),
    "onMouseOver": js.Do(nil,
        JSAction{Code: "event.target.style.backgroundColor = 'yellow'"},
    ),
    "onMouseOut": js.Do(nil,
        JSAction{Code: "event.target.style.backgroundColor = ''"},
    ),
}, "Interactive div")
```

## When to Use What

| Helper | Use Case | Executes Immediately? |
|--------|----------|----------------------|
| `js.Do()` | Event handlers (sync) | ✅ Yes (IIFE) |
| `js.AsyncDo()` | Event handlers (async) | ✅ Yes (async IIFE) |
| `js.Fn()` | Define reusable function | ❌ No (definition only) |
| `js.AsyncFn()` | Define async function | ❌ No (definition only) |

### Rule of Thumb
- **Event handlers** → Use `Do()` or `AsyncDo()`
- **Reusable functions** → Use `Fn()` or `AsyncFn()`

## Benefits

1. **Explicit Control**: Clear distinction between function definitions and immediate execution
2. **No Magic**: What you write is what gets rendered
3. **Predictable**: No hidden transformations or detection logic
4. **Debuggable**: Generated code matches source code structure
5. **Simple**: Less code in the renderer, fewer edge cases
6. **Fast**: No runtime handler registry lookups

## Technical Details

### Render Changes

**Removed:**
```go
// Complex detection and wrapping logic (70+ lines)
isArrowFunction := strings.HasPrefix(trimmedCode, "(") && strings.Contains(trimmedCode, "=>")
if isArrowFunction || isFunctionKeyword {
    handlerFn = fmt.Sprintf("function(evt,el){(%s)(evt,el);}", trimmedCode)
} else {
    handlerFn = fmt.Sprintf("function(evt,el){%s}", safeCode)
}
// Handler registry injection...
```

**Added:**
```go
// Direct rendering (simple and clear)
case JSAction:
    safeCode := strings.ReplaceAll(t.Code, "\"", "&quot;")
    sb.WriteString(fmt.Sprintf(" %s=\"%s\"", k, safeCode))
```

### Generated HTML Comparison

**Before:**
```html
<button data-gvd-handler="h-1234567890-123456|click">Click</button>
<script>
(function(){
    window.__gvd=window.__gvd||{};
    window.__gvd.handlers=window.__gvd.handlers||{};
    window.__gvd.handlers['h-1234567890-123456']={
        fn:function(evt,el){(async ()=>{alert('Hello')})(evt,el);},
        eventType:'click'
    };
})();
</script>
```

**After:**
```html
<button onclick="(async()=>{alert('Hello')})()">Click</button>
```

Much cleaner!

## New Examples and Documentation

### New Files Added

1. **examples/09_event_handlers.go** - Comprehensive event handler examples
   - Synchronous handlers with `js.Do()`
   - Asynchronous handlers with `js.AsyncDo()`
   - Complex async operations with Try/Catch
   - DOM manipulation
   - Multiple event types
   - Form events
   - Error handling

2. **docs/EVENT_HANDLER_CHANGES.md** - Detailed migration guide
   - What changed and why
   - Before/after comparisons
   - Common patterns
   - Breaking changes

3. **docs/EVENT_HANDLER_QUICK_REF.md** - Quick reference
   - Basic patterns
   - Common use cases
   - Decision tree
   - Generated code examples

### Updated Files

1. **vdom/render.go** - Simplified event handler rendering
2. **examples/05_foreach_usage.go** - Fixed API load button
3. **CHANGELOG.md** - Added v1.2.1 entry

## Testing Your Migration

After updating your code:

1. **Build your application**
   ```bash
   go build your-app.go
   ```

2. **Check browser console** for errors like:
   - "...is not a function" → Replace Fn/AsyncFn with Do/AsyncDo
   - Syntax errors → Check for missing parentheses

3. **Test all interactive elements**:
   - Buttons should respond to clicks
   - Forms should handle input
   - Async operations should complete

4. **Verify generated HTML**:
   ```html
   <!-- Good: IIFE that executes -->
   <button onclick="(()=>{alert('Hi')})()">Click</button>
   
   <!-- Bad: Function definition that doesn't execute -->
   <button onclick="()=>{alert('Hi')}">Click</button>
   ```

## Compatibility

### Backward Compatibility
- ❌ **Breaking**: Event handlers using `Fn()`/`AsyncFn()` will not work
- ✅ **Compatible**: All other APIs remain unchanged
- ✅ **Compatible**: Non-event uses of `Fn()`/`AsyncFn()` still work

### Upgrade Path
1. Update to v1.2.1
2. Run your application and test
3. If buttons/events don't work, check console for errors
4. Replace `Fn(nil, ...)` → `Do(...)`
5. Replace `AsyncFn(nil, ...)` → `AsyncDo(...)`
6. Test again

## FAQ

**Q: Why can't I use `js.Fn()` for event handlers anymore?**  
A: `js.Fn()` creates a function definition like `() => {...}`, which doesn't execute. Event handlers need immediate execution, which `js.Do()` provides via IIFEs.

**Q: What if I have complex logic in my event handler?**  
A: Use `js.Do()` or `js.AsyncDo()` with multiple statements. For very complex logic, consider extracting to a separate JavaScript file.

**Q: Do I need to change non-event uses of `Fn()`?**  
A: No. `js.Fn()` still works perfectly for defining reusable functions. Only event handlers need `Do()`/`AsyncDo()`.

**Q: How do I handle errors in async event handlers?**  
A: Wrap your async code in `js.Try(...).Catch(...).End()`:
```go
js.AsyncDo(nil,
    js.Try(
        js.Const("data", "await fetch('/api')"),
    ).Catch(
        js.Alert("'Error: ' + error.message"),
    ).End(),
)
```

**Q: Can I still use inline JavaScript strings?**  
A: Yes, but `Do()`/`AsyncDo()` is recommended for consistency and proper execution context.

## Resources

- [EVENT_HANDLER_CHANGES.md](EVENT_HANDLER_CHANGES.md) - Full migration guide
- [EVENT_HANDLER_QUICK_REF.md](EVENT_HANDLER_QUICK_REF.md) - Quick reference
- [examples/09_event_handlers.go](../examples/09_event_handlers.go) - Live examples
- [TRY_CATCH_FINALLY.md](TRY_CATCH_FINALLY.md) - Error handling guide

## Version History

- **v1.2.1** (Current) - Simplified event handlers, removed auto-wrapping
- **v1.2.0** - Introduced Try builder API, Do/AsyncDo helpers
- **v1.1.x** - Had automatic function detection (removed in v1.2.1)

## Summary

v1.2.1 makes event handling **simpler, clearer, and more predictable**. While it requires a small migration effort (replacing `Fn` with `Do` in event handlers), the result is:

- More maintainable code
- Fewer surprises
- Better error messages
- Easier debugging
- Consistent patterns

**Update now to benefit from these improvements!**