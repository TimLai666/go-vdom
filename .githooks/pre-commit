#!/bin/sh
#
# Pre-commit hook for go-vdom
# This hook runs template linting and formatting checks before allowing commits
#

set -e

echo "Running pre-commit checks..."

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_error() {
    echo "${RED}✗ $1${NC}"
}

print_success() {
    echo "${GREEN}✓ $1${NC}"
}

print_warning() {
    echo "${YELLOW}⚠ $1${NC}"
}

# Check if we're in the root of the repository
if [ ! -f "go.mod" ]; then
    print_error "Must be run from repository root"
    exit 1
fi

# 1. Run go fmt
echo "Checking code formatting..."
UNFORMATTED=$(gofmt -l . 2>&1 | grep -v "^vendor/" | grep "\.go$" || true)
if [ -n "$UNFORMATTED" ]; then
    print_error "Code is not formatted. Please run 'go fmt ./...'"
    echo "$UNFORMATTED"
    exit 1
fi
print_success "Code formatting check passed"

# 2. Run go vet
echo "Running go vet..."
if ! go vet ./... 2>&1 | grep -v "^#"; then
    print_error "go vet found issues"
    exit 1
fi
print_success "go vet passed"

# 3. Build and run template linter
echo "Building template linter..."
if [ ! -f "tools/template-linter/template-linter" ]; then
    cd tools/template-linter
    if ! go build -o template-linter; then
        cd ../..
        print_error "Failed to build template linter"
        exit 1
    fi
    cd ../..
fi

echo "Running template linter..."
cd tools/template-linter
if ! ./template-linter ../../ > /tmp/template-linter.out 2>&1; then
    cd ../..
    print_error "Template linter found issues:"
    cat /tmp/template-linter.out
    echo ""
    print_warning "Run './tools/template-linter/template-linter -fix .' to see suggestions"
    exit 1
fi
cd ../..
print_success "Template linter passed"

# 4. Run tests on affected packages (optional, can be slow)
# Uncomment if you want to run tests before every commit
# echo "Running tests..."
# if ! go test ./dom/... ./components/... -short; then
#     print_error "Tests failed"
#     exit 1
# fi
# print_success "Tests passed"

echo ""
print_success "All pre-commit checks passed!"
echo ""

exit 0
