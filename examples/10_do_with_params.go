package main

import (
	"fmt"
	"log"
	"net/http"

	js "github.com/TimLai666/go-vdom/jsdsl"
	. "github.com/TimLai666/go-vdom/vdom"
)

func main() {
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		w.Header().Set("Content-Type", "text/html; charset=utf-8")

		doc := Document(
			"Do/AsyncDo åƒæ•¸ç¤ºä¾‹",
			[]LinkInfo{
				{Rel: "stylesheet", Href: "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"},
			},
			nil,
			nil,

			Div(Props{"class": "container mt-5"},
				H1(Props{"class": "mb-4"}, "Do/AsyncDo åƒæ•¸ä½¿ç”¨ç¤ºä¾‹"),
				P(Props{"class": "lead"}, "å±•ç¤ºå¦‚ä½•åœ¨ Do() å’Œ AsyncDo() ä¸­ä½¿ç”¨åƒæ•¸"),

				Hr(),

				// 1. Do() ç„¡åƒæ•¸ï¼ˆæœ€å¸¸è¦‹ï¼‰
				Section(Props{"class": "mb-5"},
					H2(Props{"class": "mb-3"}, "1. Do() - ç„¡åƒæ•¸"),
					Div(Props{"class": "card"},
						Div(Props{"class": "card-body"},
							P(Props{"class": "text-muted"}, "æœ€å¸¸è¦‹çš„ç”¨æ³•ï¼šç›´æ¥åŸ·è¡Œä»£ç¢¼å¡Šï¼Œä¸æ¥æ”¶åƒæ•¸"),
							Pre(Props{"class": "bg-light p-3 rounded"},
								Code(`Button(Props{
	    "onClick": js.Do(nil,
	        js.Alert("'Hello!'"),
	    ),
	}, "Click")`),
							),
							Button(Props{
								"class": "btn btn-primary",
								"onClick": js.Do(nil,
									js.Alert("'Hello from Do without params!'"),
								),
							}, "æ¸¬è©¦ç„¡åƒæ•¸ Do"),
						),
					),
				),

				// 2. Do() ä½¿ç”¨ event åƒæ•¸
				Section(Props{"class": "mb-5"},
					H2(Props{"class": "mb-3"}, "2. Do() - ä½¿ç”¨ event åƒæ•¸"),
					Div(Props{"class": "card"},
						Div(Props{"class": "card-body"},
							P(Props{"class": "text-muted"}, "åœ¨äº‹ä»¶è™•ç†å™¨ä¸­ä½¿ç”¨ event å°è±¡æ™‚ï¼Œå¿…é ˆè²æ˜ç‚ºåƒæ•¸"),
							Pre(Props{"class": "bg-light p-3 rounded"},
								Code(`Button(Props{
	    "onClick": js.Do([]string{"event"},
	        js.CallMethod("event", "preventDefault"),
	        js.Const("target", "event.target"),
	        js.Log("'Button clicked:', target"),
	    ),
	}, "Click")`),
							),
							Button(Props{
								"id":    "eventBtn",
								"class": "btn btn-success",
								"onClick": js.Do([]string{"event"},
									js.Const("target", "event.target"),
									js.Const("btnText", "target.textContent"),
									js.Alert("'ä½ é»æ“Šäº†æŒ‰éˆ•: ' + btnText"),
								),
							}, "æ¸¬è©¦ event å°è±¡"),
							Div(Props{"class": "alert alert-info mt-3"},
								Strong("æç¤ºï¼š"), " åœ¨ IIFE ä¸­ä½¿ç”¨ event å°è±¡æ™‚ï¼Œå¿…é ˆå°‡å…¶è²æ˜ç‚ºåƒæ•¸ä¸¦å‚³éã€‚",
							),
						),
					),
				),

				// 3. Do() ä½¿ç”¨è‡ªå®šç¾©åƒæ•¸ï¼ˆè¼ƒå°‘è¦‹ï¼‰
				Section(Props{"class": "mb-5"},
					H2(Props{"class": "mb-3"}, "3. Do() - è‡ªå®šç¾©åƒæ•¸ï¼ˆé€²éšï¼‰"),
					Div(Props{"class": "card"},
						Div(Props{"class": "card-body"},
							P(Props{"class": "text-muted"}, "å¯ä»¥å®šç¾©è‡ªå®šç¾©åƒæ•¸ï¼Œä½†åœ¨äº‹ä»¶è™•ç†å™¨ä¸­è¼ƒå°‘ä½¿ç”¨"),
							Pre(Props{"class": "bg-light p-3 rounded"},
								Code(`Button(Props{
    "onClick": js.Do(nil,[]string{"evt", "customArg"},
        js.CallMethod("evt", "preventDefault"),
        js.Log("'Custom arg:', customArg"),
    ),
}, "Click")`),
							),
							Div(Props{"class": "alert alert-warning"},
								Strong("æ³¨æ„ï¼š"), " åœ¨ onClick ç­‰äº‹ä»¶è™•ç†å™¨ä¸­ï¼Œè‡ªå®šç¾©åƒæ•¸é€šå¸¸ä¸æœƒè¢«å‚³å…¥ã€‚",
								" é€™å€‹åŠŸèƒ½ä¸»è¦ç”¨æ–¼å®šç¾©å¯é‡ç”¨çš„å‡½æ•¸ï¼Œè€Œéç›´æ¥ç”¨åœ¨äº‹ä»¶è™•ç†å™¨ä¸Šã€‚",
							),
						),
					),
				),

				// 4. AsyncDo() ç„¡åƒæ•¸
				Section(Props{"class": "mb-5"},
					H2(Props{"class": "mb-3"}, "4. AsyncDo() - ç„¡åƒæ•¸"),
					Div(Props{"class": "card"},
						Div(Props{"class": "card-body"},
							P(Props{"class": "text-muted"}, "ç•°æ­¥æ“ä½œçš„æ¨™æº–ç”¨æ³•"),
							Pre(Props{"class": "bg-light p-3 rounded"},
								Code(`Button(Props{
	    "onClick": js.AsyncDo(nil,
	        js.Const("response", "await fetch('/api')"),
	        js.Alert("'Done!'"),
	    ),
	}, "Load")`),
							),
							Button(Props{
								"class": "btn btn-info mb-3",
								"onClick": js.AsyncDo(nil,
									js.Alert("'é–‹å§‹ç•°æ­¥æ“ä½œ...'"),
									JSAction{Code: "await new Promise(r => setTimeout(r, 1000))"},
									js.Alert("'ç•°æ­¥æ“ä½œå®Œæˆï¼'"),
								),
							}, "æ¸¬è©¦ç•°æ­¥æ“ä½œï¼ˆ1ç§’å»¶é²ï¼‰"),
						),
					),
				),

				// 5. AsyncDo() ä½¿ç”¨ event åƒæ•¸
				Section(Props{"class": "mb-5"},
					H2(Props{"class": "mb-3"}, "5. AsyncDo() - ä½¿ç”¨ event åƒæ•¸"),
					Div(Props{"class": "card"},
						Div(Props{"class": "card-body"},
							P(Props{"class": "text-muted"}, "åœ¨ç•°æ­¥äº‹ä»¶è™•ç†å™¨ä¸­ä½¿ç”¨ event å°è±¡ï¼Œä¹Ÿéœ€è¦è²æ˜åƒæ•¸"),
							Pre(Props{"class": "bg-light p-3 rounded"},
								Code(`Button(Props{
	    "onClick": js.AsyncDo([]string{"event"},
	        js.Const("btnId", "event.target.id"),
	        js.Log("'Button ID:', btnId"),
	        JSAction{Code: "await someAsyncOperation()"},
	    ),
	}, "Async Click")`),
							),
							Button(Props{
								"id":    "asyncEventBtn",
								"class": "btn btn-warning mb-3",
								"onClick": js.AsyncDo([]string{"event"},
									js.Const("btnId", "event.target.id"),
									js.Const("btnClass", "event.target.className"),
									js.Alert("'æŒ‰éˆ• ID: ' + btnId"),
									JSAction{Code: "await new Promise(r => setTimeout(r, 500))"},
									js.Alert("'æŒ‰éˆ• class: ' + btnClass"),
								),
							}, "æ¸¬è©¦ç•°æ­¥ + event"),
						),
					),
				),

				// 6. å¯¦éš›æ‡‰ç”¨ï¼šè¡¨å–®è™•ç†
				Section(Props{"class": "mb-5"},
					H2(Props{"class": "mb-3"}, "6. å¯¦éš›æ‡‰ç”¨ - è¡¨å–®è™•ç†"),
					Div(Props{"class": "card"},
						Div(Props{"class": "card-body"},
							P(Props{"class": "text-muted"}, "åœ¨è¡¨å–®æäº¤ä¸­ä½¿ç”¨ event.preventDefault()"),
							Form(Props{
								"id": "testForm",
								"onSubmit": js.Do([]string{"event"},
									js.CallMethod("event", "preventDefault"),
									js.Const("formData", "new FormData(event.target)"),
									js.Const("name", "formData.get('name')"),
									js.Const("email", "formData.get('email')"),
									js.Alert("'æäº¤è¡¨å–®ï¼\\nå§“å: ' + name + '\\néƒµç®±: ' + email"),
								),
							},
								Div(Props{"class": "mb-3"},
									Label(Props{"class": "form-label", "for": "name"}, "å§“åï¼š"),
									Input(Props{
										"type":  "text",
										"class": "form-control",
										"id":    "name",
										"name":  "name",
										"value": "å¼µä¸‰",
									}),
								),
								Div(Props{"class": "mb-3"},
									Label(Props{"class": "form-label", "for": "email"}, "éƒµç®±ï¼š"),
									Input(Props{
										"type":  "email",
										"class": "form-control",
										"id":    "email",
										"name":  "email",
										"value": "zhangsan@example.com",
									}),
								),
								Button(Props{
									"type":  "submit",
									"class": "btn btn-primary",
								}, "æäº¤è¡¨å–®"),
							),
						),
					),
				),

				// 7. å¯¦éš›æ‡‰ç”¨ï¼šè¼¸å…¥è™•ç†
				Section(Props{"class": "mb-5"},
					H2(Props{"class": "mb-3"}, "7. å¯¦éš›æ‡‰ç”¨ - å³æ™‚è¼¸å…¥è™•ç†"),
					Div(Props{"class": "card"},
						Div(Props{"class": "card-body"},
							P(Props{"class": "text-muted"}, "ç›£è½è¼¸å…¥æ¡†è®ŠåŒ–ä¸¦å³æ™‚é¡¯ç¤º"),
							Div(Props{"class": "mb-3"},
								Label(Props{"class": "form-label"}, "è¼¸å…¥æ–‡å­—ï¼š"),
								Input(Props{
									"type":  "text",
									"class": "form-control",
									"id":    "liveInput",
									"onInput": js.Do([]string{"event"},
										js.Const("value", "event.target.value"),
										js.Const("length", "value.length"),
										JSAction{Code: "document.getElementById('liveOutput').textContent = value"},
										JSAction{Code: "document.getElementById('charCount').textContent = length + ' å­—ç¬¦'"},
									),
								}),
							),
							Div(Props{"class": "alert alert-info"},
								Div(Props{"id": "liveOutput", "class": "fw-bold"}, "ä½ è¼¸å…¥çš„å…§å®¹æœƒå³æ™‚é¡¯ç¤ºåœ¨é€™è£¡..."),
								Div(Props{"id": "charCount", "class": "text-muted small mt-2"}, "0 å­—ç¬¦"),
							),
						),
					),
				),

				// 8. å¯¦éš›æ‡‰ç”¨ï¼šé¸æ“‡æ¡†è™•ç†
				Section(Props{"class": "mb-5"},
					H2(Props{"class": "mb-3"}, "8. å¯¦éš›æ‡‰ç”¨ - é¸æ“‡æ¡†è™•ç†"),
					Div(Props{"class": "card"},
						Div(Props{"class": "card-body"},
							P(Props{"class": "text-muted"}, "ç›£è½é¸æ“‡æ¡†è®ŠåŒ–"),
							Div(Props{"class": "mb-3"},
								Label(Props{"class": "form-label"}, "é¸æ“‡ä½ å–œæ­¡çš„é¡è‰²ï¼š"),
								Select(Props{
									"class": "form-select",
									"onChange": js.Do([]string{"event"},
										js.Const("selectedValue", "event.target.value"),
										js.Const("selectedText", "event.target.options[event.target.selectedIndex].text"),
										JSAction{Code: "document.getElementById('colorPreview').style.backgroundColor = selectedValue"},
										JSAction{Code: "document.getElementById('colorName').textContent = 'ä½ é¸æ“‡äº†ï¼š' + selectedText"},
									),
								},
									Option(Props{"value": ""}, "è«‹é¸æ“‡..."),
									Option(Props{"value": "#ff6b6b"}, "ç´…è‰²"),
									Option(Props{"value": "#4ecdc4"}, "é’è‰²"),
									Option(Props{"value": "#45b7d1"}, "è—è‰²"),
									Option(Props{"value": "#96ceb4"}, "ç¶ è‰²"),
									Option(Props{"value": "#ffeaa7"}, "é»ƒè‰²"),
									Option(Props{"value": "#dfe6e9"}, "ç°è‰²"),
								),
							),
							Div(Props{
								"id":    "colorPreview",
								"class": "border rounded p-4 mb-2",
								"style": "min-height: 100px; transition: background-color 0.3s;",
							}),
							Div(Props{
								"id":    "colorName",
								"class": "text-center text-muted",
							}, "è«‹é¸æ“‡ä¸€å€‹é¡è‰²"),
						),
					),
				),

				// ç¸½çµ
				Section(Props{"class": "mb-5"},
					H2(Props{"class": "mb-3"}, "âœ… ä½¿ç”¨æŒ‡å—"),
					Div(Props{"class": "row"},
						Div(Props{"class": "col-md-6"},
							Div(Props{"class": "card h-100 border-success"},
								Div(Props{"class": "card-header bg-success text-white"},
									H5(Props{"class": "mb-0"}, "æ¨è–¦ç”¨æ³•"),
								),
								Div(Props{"class": "card-body"},
									H6("Do() / AsyncDo() ç„¡åƒæ•¸ï¼š"),
									Ul(
										Li("ç”¨æ–¼ä¸éœ€è¦ event å°è±¡çš„ç°¡å–®æ“ä½œ"),
										Li("å¦‚ alertã€console.logã€ç°¡å–® DOM æ“ä½œ"),
										Li("ä¸æ¶‰åŠ event å°è±¡æ™‚ä½¿ç”¨"),
									),
									Pre(Props{"class": "bg-light p-2 rounded small"},
										Code(`js.Do(nil,
    js.Alert("'Hello!'"),
    js.Log("'No event needed'"),
)`),
									),
								),
							),
						),
						Div(Props{"class": "col-md-6"},
							Div(Props{"class": "card h-100 border-warning"},
								Div(Props{"class": "card-header bg-warning"},
									H5(Props{"class": "mb-0"}, "é€²éšç”¨æ³•"),
								),
								Div(Props{"class": "card-body"},
									H6("Do() / AsyncDo() å¸¶åƒæ•¸ï¼š"),
									Ul(
										Li("éœ€è¦ä½¿ç”¨ event å°è±¡æ™‚å¿…é ˆè²æ˜"),
										Li(Strong("äº‹ä»¶è™•ç†å™¨ä¸­ä½¿ç”¨ event å¿…é ˆè²æ˜åƒæ•¸")),
										Li("è¡¨å–®æäº¤ã€è¼¸å…¥è®ŠåŒ–ç­‰éƒ½éœ€è¦ event"),
									),
									Pre(Props{"class": "bg-light p-2 rounded small"},
										Code(`js.Do([]string{"event"},
    js.Const("val", "event.target.value"),
    js.Alert("val"),
)`),
									),
								),
							),
						),
					),
				),

				Section(Props{"class": "mb-5"},
					Div(Props{"class": "alert alert-info"},
						H5("ğŸ’¡ é—œéµè¦é»ï¼š"),
						Ul(Props{"class": "mb-0"},
							Li(Strong("Do()"), " ç”¨æ–¼åŒæ­¥æ“ä½œ"),
							Li(Strong("AsyncDo()"), " ç”¨æ–¼ç•°æ­¥æ“ä½œï¼ˆå¯ä½¿ç”¨ awaitï¼‰"),
							Li(Strong("é‡è¦"), "ï¼šä½¿ç”¨ ", Code("event"), " å°è±¡æ™‚å¿…é ˆè²æ˜åƒæ•¸ï¼š", Code("[]string{\"event\"}")),
							Li("ä¸ä½¿ç”¨ event æ™‚å‚³ ", Code("nil")),
							Li("IIFE æœƒå‰µå»ºæ–°ä½œç”¨åŸŸï¼Œevent å¿…é ˆé¡¯å¼å‚³é"),
						),
					),
				),
			),
		)

		fmt.Fprint(w, Render(doc))
	})

	port := ":8090"
	fmt.Printf("Do/AsyncDo åƒæ•¸ç¤ºä¾‹æœå‹™å™¨å·²å•Ÿå‹•ï¼Œè«‹è¨ªå• http://localhost%s\n", port)
	log.Fatal(http.ListenAndServe(port, nil))
}
